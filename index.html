<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Spin Hadiah</title>
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@2/tsparticles.bundle.min.js"></script>
  <style>
.loading-dots::after {
  content: '';
  display: inline-block;
  animation: dotsAnim 1s steps(3, end) infinite;
}
@keyframes dotsAnim {
  0%   { content: ''; }
  33%  { content: '.'; }
  66%  { content: '..'; }
  100% { content: '...'; }
}
.judul-keren {
  font-family: 'Arial Black', sans-serif;
  font-size: 48px;
  font-weight: 900;
  color: white;
  text-align: center;
  text-shadow:
    2px 2px 0 #000,
    4px 4px 0 #000,
    6px 6px 10px rgba(0, 0, 0, 0.8);
  letter-spacing: 2px;
  margin-top: 60px;
}
.blink { animation: blink-animation 1s infinite; }
@keyframes blink-animation {
  0%, 100% { background-color: #ffcc00; }
  50% { background-color: #ff0000; color: white; }
}
.box.terbuka {
  background: gold;
  color: black;
  font-size: 28px;
  font-weight: bold;
  text-align: center;
  transform: scale(1.05);
  transition: 0.5s ease;
  text-shadow: 1px 1px 0 #fff, 2px 2px 0 #aaa, 3px 3px 0 #777;
}
#boxArea { animation: fadeIn 0.5s ease; }
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}
.wrapper { display: flex; justify-content: center; align-items: center; width: 100%; }
.box-container {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;
  justify-content: center; align-content: center;
}
@media screen and (max-width: 600px) {
  .input-wrapper { flex-direction: column; align-items: center; }
}
.input-wrapper { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
a:hover img { filter: brightness(1.2); transform: scale(1.05); transition: 0.3s; }
.banner-berjalan {
  width: 100%; background: #ffcc00; color: black; padding: 8px 0; font-weight: bold; font-size: 16px;
  position: fixed; top: 0; left: 0; z-index: 9999; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
/* Input & tombol */
input, button { padding: 10px 15px; font-size: 16px; margin: 5px; border-radius: 5px; }
.klaim-button {
  display: inline-block; padding: 10px 20px; background: #ffcc00; color: black; font-weight: bold;
  text-decoration: none; border-radius: 8px; transition: background 0.3s ease;
}
.klaim-button:hover { background: #ffaa00; }
button:hover {
  background-color: #ffaa00; transform: scale(1.05); transition: 0.2s ease; cursor: pointer; box-shadow: 0 0 10px #ffcc00;
}
#historyBox {
  display: none; margin: 40px auto; padding: 20px; max-width: 500px; background: rgba(255, 255, 255, 0.1);
  border-radius: 12px; color: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.5); text-align: left; font-size: 16px;
}
#historyBox ul { list-style: none; padding-left: 0; }
#historyBox li { animation: fadeInUp 0.3s ease-in-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); }
}
html, body {
  margin: 0; padding: 0; background: #8d0a0a !important; font-family: 'Segoe UI', sans-serif;
  color: #fff; text-align: center; height: auto; min-height: 100vh; overflow-x: hidden; overflow-y: auto;
}
#tsparticles { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; }
body { position: relative; z-index: 1; padding-bottom: 50px; }
.box {
  width: 150px; height: 150px; background: transparent; font-size: 90px; color: white; display: flex;
  align-items: center; justify-content: center; cursor: pointer; border: none; outline: none;
}
.box.clicked { animation: diceShake 0.2s ease-in-out 10; }
.box:hover { transform: scale(1.2) rotate(5deg); box-shadow: 0 0 15px #ffffff80; transition: 0.3s ease; }
@keyframes diceShake {
  0% { transform: translate(0,0) rotate(0deg);} 10% { transform: translate(-3px, -5px) rotate(15deg);}
  20% { transform: translate(5px, 3px) rotate(-15deg);} 30% { transform: translate(-4px, 6px) rotate(10deg);}
  40% { transform: translate(6px, -4px) rotate(-10deg);} 50% { transform: translate(-6px, 5px) rotate(20deg);}
  60% { transform: translate(5px, -3px) rotate(-20deg);} 70% { transform: translate(-3px, 4px) rotate(10deg);}
  80% { transform: translate(4px, -6px) rotate(-10deg);} 90% { transform: translate(-5px, 3px) rotate(5deg);}
  100% { transform: translate(0, 0) rotate(0deg);}
}
.popup {
  position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: flex-start;
  padding-top: 300px; overflow-y: auto; z-index: 9999;
}
.popup-card {
  background: white; color: black; padding: 25px 30px; border-radius: 14px; font-size: 28px; font-weight: bold;
  box-shadow: 0 8px 30px rgba(0,0,0,0.4); max-width: 320px; width: 100vw; text-align: center; margin-left: -25px;
}
  </style>
</head>
<body>

<audio id="sfxPutar" src="https://yourdomain.com/path-to/hyperdrive-sound-effect.wav" preload="auto"></audio>

<div id="tsparticles"></div>

<div class="banner-berjalan">
  <marquee behavior="scroll" direction="left">
    SELAMAT DATANG DI RANDOM BOX SLOTBANGJAGO! HARI INI KAMU PUNYA KESEMPATAN UNTUK BUKA SATU DARI 9 BOX YANG ISINYA 100% BERHADIAHğŸ
  </marquee>
</div>

<h1 class="judul-keren"> RANDOM BOX PRIZE </h1>
<div style="text-align: center; margin-top: 10px;">
  <a href="https://18slotbangjago.com/" target="_blank">
    <img src="https://dpw3m2v9dxyrl.cloudfront.net/498/assets/banner/IND/Logo%20Slot%20Bang%20Jago%20200x90.png?V=1748482602" alt="Slot Bangjago" style="height: 100px; cursor: pointer;">
  </a>
</div>

<div id="formPage" class="input-wrapper" style="flex-direction: column; align-items: center;">
  <input type="text" id="nama" placeholder="USERNAME" />
  <input type="text" id="kode" placeholder="KODE TOKEN" />
  <div style="margin-top: 10px;">
    <button id="btnVerifikasi" onclick="spinStart()">ğŸ”’ <span id="btnText">MULAI VERIFIKASI</span></button>
  </div>
</div>

<div id="boxPage" style="display:none; animation: fadeIn 0.5s ease;">
  <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;">
    <button onclick="tampilkanHistoryGabungan()">ğŸ“œ <span id="textHistori">CEK HISTORI</span></button>
    <button onclick="kembaliKeForm()">ğŸ”™ KEMBALI</button>
  </div>
  <div id="historyBox" style="display:none; margin-top: 30px; color: white;"></div>
  <div class="wrapper">
    <div class="box-container" id="boxArea">
      <div class="box" onclick="pilihBox(this)">ğŸ</div>
      <div class="box" onclick="pilihBox(this)">ğŸ</div>
      <div class="box" onclick="pilihBox(this)">ğŸ</div>
      <div class="box" onclick="pilihBox(this)">ğŸ</div>
      <div class="box" onclick="pilihBox(this)">ğŸ</div>
      <div class="box" onclick="pilihBox(this)">ğŸ</div>
      <div class="box" onclick="pilihBox(this)">ğŸ</div>
      <div class="box" onclick="pilihBox(this)">ğŸ</div>
      <div class="box" onclick="pilihBox(this)">ğŸ</div>
    </div>
  </div>
</div>

<div id="hasil"></div>

<div id="popupHadiah" class="popup">
  <div class="popup-card">
    <div id="popupContent" style="margin-bottom: 15px;"></div>
    <a href="https://t.me/+MYu2cG2rBPwzNGQ9" target="_blank" class="klaim-button">
      <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram" style="height: 20px; vertical-align: middle; margin-right: 8px;">
      KLAIM BONUS DISINI
    </a>
    <div style="margin-top: 20px;"></div>
  </div>
</div>

<audio id="sfxWin" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-notification-2018.mp3"></audio>

<script>
// ====== API fetch helper ======
const API = "https://script.google.com/macros/s/AKfycbx9-kv79wzrV4ZFWpODh1YXqnkpkiUt0qoNI61WbUSN-wxYFRjlEl-imsGp2v9krHhKsg/exec";
async function apiGet(qs) {
  const res = await fetch(`${API}?${qs}`, { method: "GET" });
  return res.json();
}
async function apiPost(formObj) {
  const res = await fetch(API, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
    body: new URLSearchParams(formObj)
  });
  return res.json();
}

// Tutup popup kalau klik di luar kartu
document.getElementById("popupHadiah").addEventListener("click", function(e) {
  if (!e.target.closest(".popup-card")) {
    document.getElementById("popupHadiah").style.display = "none";
  }
});

// Partikel background
window.onload = () => {
  tsParticles.load("tsparticles", {
    background: { color: { value: "#8d0a0a" } },
    particles: {
      number: { value: 100, density: { enable: true, area: 800 } },
      color: { value: "#ffffff" },
      shape: { type: "circle" },
      opacity: { value: 0.4 },
      size: { value: 3, random: true },
      links: { enable: true, distance: 130, color: "#ffffff", opacity: 0.4, width: 1 },
      move: { enable: true, speed: 1.2, direction: "none", outModes: { default: "bounce" } }
    },
    interactivity: { events: { onhover: { enable: false }, onclick: { enable: false }, resize: true } },
    detectRetina: true
  });
};

// ===== Variabel global =====
let namaUser = "";
let kodeToken = "";
const hadiahList = [3000, 3000, 4000, 5000, 4000, 5000, 3000, 4000, 3000];
let hadiahUtama = "";
let indexDipilih = -1;
let hadiahLain = [];
let sudahSpin = false;

// ===== Logic versi fetch() =====
async function spinStart() {
  namaUser = document.getElementById("nama").value.trim();
  kodeToken = document.getElementById("kode").value.trim();

  const btnText = document.getElementById("btnText");
  const hasilEl = document.getElementById("hasil");

  if (!namaUser || !kodeToken) {
    alert("Isi nama dan kode token dulu!");
    return;
  }

  btnText.innerText = "MEMPROSES";
  btnText.classList.add("loading-dots");
  hasilEl.innerHTML = "â³ Memproses...";

  try {
    const json = await apiPost({ action: "cekdanpakaitoken", nama: namaUser, kode: kodeToken });
    btnText.innerText = "MULAI VERIFIKASI";
    btnText.classList.remove("loading-dots");

    if (json.status === "OK") {
      hasilEl.innerHTML = "";
      document.getElementById("formPage").style.display = "none";
      document.getElementById("boxPage").style.display = "block";
      document.querySelectorAll(".box").forEach(box => {
        box.innerHTML = "ğŸ";
        box.style.pointerEvents = "auto";
      });
    } else {
      hasilEl.innerHTML = `<span style="font-weight:800;">âŒ ${json.msg || "Kode tidak valid"}</span>`;
    }
  } catch (e) {
    btnText.innerText = "MULAI VERIFIKASI";
    btnText.classList.remove("loading-dots");
    hasilEl.innerHTML = "âš ï¸ Error koneksi.";
  }
}

function bukaSemuaBox() {
  const boxes = document.querySelectorAll(".box");
  boxes.forEach((box, i) => {
    setTimeout(() => {
      box.classList.add("terbuka");
      box.style.pointerEvents = "none";
      if (i === indexDipilih) {
        box.classList.add("blink", "terbuka");
        box.innerHTML = `
          <div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-start;height:100%;line-height:1;padding-top:45px;">
            <div style="font-size:20px;margin-bottom:20px;">ğŸ¯</div>
            <div style="font-size:28px;font-weight:bold;">${hadiahUtama}</div>
          </div>
        `;
      } else {
        const angka = parseInt(hadiahLain[i]) || 0;
        box.style.background = "#FFD700";
        box.style.color = "black";
        box.innerHTML = `Rp${angka.toLocaleString("id-ID")}`;
      }
    }, i * 100);
  });
}

async function pilihBox(el) {
  if (sudahSpin) return;
  sudahSpin = true;

  const boxes = document.querySelectorAll(".box");
  indexDipilih = [...boxes].indexOf(el);

  document.getElementById("sfxPutar").play();
  el.classList.add("clicked");

  // Ambil 9 hadiah lain (AE2:AE10) dari API
  try {
    const sisa = await apiGet("action=getSisaHadiah");
    // Apps Script kamu mengembalikan array langsung -> pakai sisa, kalau dibungkus objek, pakai sisa.data
    hadiahLain = Array.isArray(sisa) ? sisa : (sisa.data || []);
  } catch {
    hadiahLain = [];
  }
  // Jaga-jaga panjang array
  while (hadiahLain.length < 9) hadiahLain.push(3000);

  setTimeout(async () => {
    el.classList.remove("clicked");

    const hadiah = hadiahList[Math.floor(Math.random() * hadiahList.length)];
    hadiahUtama = `Rp${hadiah.toLocaleString("id-ID")}`;
    const statusPopup = `MENANG ${hadiahUtama}`;

    try {
      await apiPost({ action: "simpanhasil", nama: namaUser, kode: kodeToken, status: hadiahUtama });
    } catch {}

    bukaSemuaBox();

    setTimeout(() => {
      document.getElementById("popupContent").innerHTML = `
        <img src="https://dpw3m2v9dxyrl.cloudfront.net/498/assets/banner/IND/Logo%20Slot%20Bang%20Jago%20200x90.png?V=1748482602" style="height:70px;margin-bottom:10px;"><br>
        ğŸ‰<br><strong>${statusPopup}</strong>
        <div style="margin-top:10px;font-size:14px;color:#555;">
          SCREENSHOT DAN KLAIM HADIAH MELALUI <b>TELEGRAM</b>.
        </div>
      `;
      document.getElementById("popupHadiah").style.display = "flex";
      document.getElementById("sfxWin").play();
    }, 2000);
  }, 300);
}

async function tampilkanHistoryGabungan() {
  const user = document.getElementById("nama").value.trim();
  const historyEl = document.getElementById("historyBox");
  const textHistori = document.getElementById("textHistori");

  let dotCount = 0;
  const intervalHistori = setInterval(() => {
    dotCount = (dotCount + 1) % 4;
    textHistori.innerText = "LOADING" + ".".repeat(dotCount);
  }, 300);

  document.getElementById("boxArea").style.display = "none";

  if (!user) {
    clearInterval(intervalHistori);
    textHistori.innerText = "CEK HISTORI";
    historyEl.style.display = "block";
    historyEl.innerHTML = "<p style='color:yellow;'>âŒ Masukkan nama dulu sebelum cek histori!</p>";
    return;
  }

  try {
    const data = await apiGet(`action=ambilHistoriGabungan&nama=${encodeURIComponent(user)}`);
    clearInterval(intervalHistori);
    textHistori.innerText = "CEK HISTORI";

    if (!data || ((!data.member || []).length === 0 && (!data.fake || []).length === 0)) {
      historyEl.style.display = "block";
      historyEl.innerHTML = "<p style='color:orange;'>âš ï¸ Tidak ada histori ditemukan untuk nama ini.</p>";
      return;
    }

    let html = `
      <div style="margin-bottom:10px;padding:8px;background:linear-gradient(to right,#ffcc00,#ff9900);color:#000;font-weight:bold;border-radius:6px;">
        ğŸ¥‡Kemenangan Mulai dari Rp2.000 - Rp1.000.000 ğŸ’°
      </div>
      <h3>ğŸ‰ Pemenang Hari Ini</h3>
      <ul style="text-align:left;">
    `;
    (data.member || []).forEach(row => {
      html += `<li>ğŸ† <strong>${row.nama}</strong> Memenangkan <span style="color:gold;">${row.status}</span></li>`;
    });
    (data.fake || []).forEach(text => {
      const m = text.match(/(.+?) Memenangkan (Rp .+)/);
      html += m
        ? `<li>ğŸ† <strong>${m[1]}</strong> Memenangkan <span style="color:gold;">${m[2]}</span></li>`
        : `<li>ğŸ† ${text}</li>`;
    });
    html += '</ul>';

    historyEl.innerHTML = html;
    historyEl.style.display = "block";
  } catch (e) {
    clearInterval(intervalHistori);
    textHistori.innerText = "CEK HISTORI";
    historyEl.style.display = "block";
    historyEl.innerHTML = "<p style='color:salmon;'>âš ï¸ Error ambil histori.</p>";
  }
}

function kembaliKeForm() {
  document.getElementById("formPage").style.display = "block";
  document.getElementById("boxPage").style.display = "none";
  document.getElementById("historyBox").style.display = "none";
  document.getElementById("boxArea").style.display = "grid";

  document.querySelectorAll(".box").forEach(box => {
    box.innerHTML = "ğŸ";
    box.classList.remove("terbuka", "clicked", "blink");
    box.style.pointerEvents = "auto";
    // reset style manual
    box.style.background = "transparent";
    box.style.color = "white";
    box.style.boxShadow = "";
    box.style.transform = "";
  });

  document.getElementById("popupHadiah").style.display = "none";
  sudahSpin = false;
}
</script>
</body>
</html>
